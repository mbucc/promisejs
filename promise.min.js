/*
 *  Copyright 2012-2013 (c) Pierre Duquesne <stackp@online.fr>
 *  Licensed under the New BSD License.
 *  https://github.com/stackp/promisejs
 */
(function(e){function t(){this._callbacks=[]}function n(e){function o(e){return function(){i+=1,r[e]=Array.prototype.slice.call(arguments),i===s&&n.done(r)}}var n=new t,r=[];if(!e||!e.length)return n.done(r),n;var i=0,s=e.length;for(var u=0;u<s;u++)e[u].then(o(u));return n}function r(e,n){var i=new t;return e.length===0?i.done.apply(i,n):e[0].apply(null,n).then(function(){e.splice(0,1),r(e,arguments).then(function(){i.done.apply(i,arguments)})}),i}function i(e){var t="";if(typeof e=="string")t=e;else{var n=encodeURIComponent;for(var r in e)e.hasOwnProperty(r)&&(t+="&"+n(r)+"="+n(e[r]))}return t}function s(){var e;if(window.XMLHttpRequest)e=new XMLHttpRequest;else if(window.ActiveXObject)try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){e=new ActiveXObject("Microsoft.XMLHTTP")}return e}function o(e,n,r,o){function p(){f.abort(),u.done(a.ETIMEOUT,"",f)}var u=new t,f,l;r=r||{},o=o||{};try{f=s()}catch(c){return u.done(a.ENOXHR,""),u}l=i(r),e==="GET"&&l&&(n+="?"+l,l=null),f.open(e,n),f.setRequestHeader("Content-type","application/x-www-form-urlencoded");for(var h in o)o.hasOwnProperty(h)&&f.setRequestHeader(h,o[h]);var d=a.ajaxTimeout;if(d)var v=setTimeout(p,d);return f.onreadystatechange=function(){d&&clearTimeout(v);if(f.readyState===4){var e=!f.status||(f.status<200||f.status>=300)&&f.status!==304,t=f.responseText;if((f.getResponseHeader("Content-Type")||"").indexOf("json")>-1)try{t=JSON.parse(t)}catch(n){e=a.EDECODEJSON}u.done(e,t,f)}},f.send(l),u}function u(e){return function(t,n,r){return o(e,t,n,r)}}t.prototype.then=function(e,n){var r;return this._isdone?r=e.apply(n,this.result):(r=new t,this._callbacks.push(function(){var t=e.apply(n,arguments);t&&typeof t.then=="function"&&t.then(r.done,r)})),r},t.prototype.done=function(){this.result=arguments,this._isdone=!0;for(var e=0;e<this._callbacks.length;e++)this._callbacks[e].apply(null,arguments);this._callbacks=[]};var a={Promise:t,join:n,chain:r,ajax:o,get:u("GET"),post:u("POST"),put:u("PUT"),del:u("DELETE"),ENOXHR:1,ETIMEOUT:2,EDECODEJSON:3,ajaxTimeout:0};typeof define=="function"&&define.amd?define(function(){return a}):e.promise=a})(this)